# 4-1 벌크 형과 스트리밍 형의 데이터 수집

## 객체 스토리지와 데이터 수집

빅데이터는 대부분 확장성이 높은 분산 스토리지(distributed strogae)에 저장된다.

분산 스토리지 중에서 가장 기본이 되는 건 객체 스토리지(object storage)이다. 

객체 스토리지
- 특징
    - 다수의 컴퓨터를 사용하여 파일을 여러 디스크에 복사함으로써 데이터 중복화 및 부하 분산을 실현
    - 파일 읽고 쓰기는 네트워크를 거쳐서 실행된다.
- 장점
    - 데이터는 항상 여러 디스크에 복사되기 때문에 일부 하드웨어가 고장 나더라도 데이터가 손실되지 않는다.
    - 데이터의 읽고 쓰기를 다수의 하드웨어에 분산함으로써 데이터 양이 늘어나도 성능이 떨어지는 일이 없도록 고안되어 있다.
- 단점
    - 소량의 데이터에 대해 비효율적이다.
    - 100 바이트 정도의 작은 파일을 자주 읽고 쓰는건 데이터양에 비해 통신 오버헤드가 너무 크다
- 적절한 데이터 크기
    - 효율적으로 처리할 수 있는 파일 크기는 대략 1MB ~ 1GB
    - 데이터 크기가 작고, 파일수가 많으면 통신 오버헤드가 너무 커진다
    - 데이터 크기가 크고, 파일수가 적으면 네트워크 전송에 시간이 걸려 예상치 못한 오류 발생률이 높아진다.
    - 작은 데이터는 모아서 하나로 만들고, 큰 데이터는 복수로 나누는 것을 고려하라
    
데이터 수집(data ingestion) : 수집한 데이터를 가공하여 집계 효율이 좋은 분산 스토리지를 만드는 일련의 프로세스 

## 벌크 형의 데이터 전송

전통적인 데이터 웨어하우스에서 사용되던 방식.

데이터베이스나 파일서버, 웹 서비스 등에서 각각의 방식(SQL, API)로 데이터를 추출

과거에 축적된 대량의 데이터가 이미 있는 경우나 기존의 DB에서 데이터를 추출하고 싶을 때 사용

벌크형 데이터 전송을 위한 ETL 서버가 필요
- 데이터 웨어하우스를 위한 ETL 도구
- 오픈소스 벌크 전송 도구
- 손수 작성한 스크립트

벌크형 전송의 파일 사이즈
- 100개의 파일을 전송하는데 100번 전송을 하고 있다면 모아서 전송하는 것이 좋다
- 너무 많은 양의 데이터를 한꺼번에 전송하려고 하는 것도 위험하다. 한 달 혹은 하루 단위로 태스크를 분해하라. 

재처리
- 데이터 전송의 신뢰성이 중요한 경우엔 가능한 한 벌크형 도구를 사용해야 한다.
- 뭔가 문제가 발생했을 때 여러번 데이터 전송을 재실행할 수 있다는 점이 벌크형의 장점이다.

워크플로
- 스트리밍형 전송은 특성상 실시간으로 계속 동작하는 것을 전제로 하므로 워크플로의 일부로 실행하지 않는다.
- 과거의 데이터를 빠짐없이 가져오거나 실패한 작업을 재실행할 것을 고려한다면, 벌크형 전송을 해야 한다.

## 스트리밍형의 데이터 전송

메시지 배송(message delivery)
- 웹브라우저, 모바일 앱, 디바이스 등 다수의 클라이언트에서 계속해서 작은 데이터가 전송되는 방식
- 전송되는 데이터양에 비해 통신을 위한 오버헤드가 커서, 이를 처리하는 서버는 높은 성능을 요구

메시지 저장 방법
- NoSQL DB : 작은 데이터 쓰기에 적합
- 메시지 큐, 메시지 브로커 등의 중계 시스템
- 기록된 데이터는 일정한 간격으로 꺼내고 모아서 함께 분산 스토리지에 저장

메시지 배송 방법
- 서버에서 임시 파일에 데이터를 축적해 두고 Logstash나 Fluentd 같은 서버 상주형 로그 수집 소프트웨어를 사용하여 메시지 브로커에 전달
- MQTT(MQ Telemetry Transport) 프로토콜을 사용하여 Pub/Sub형 메시지 배송 구조를 만든다.

# 4-2 [성능x신뢰성] 메시지 배송의 트레이드 오프

## 메시지 브로커

- 메시지 배송에 의해 보내진 데이터를 분산 스토리지에 저장할 때 주의가 필요함.
- 대량의 메시지를 안정적으로 받으려면 빈번한 쓰기에 견딜 수 있는 스토리지가 필요한데, 분산 스토리지가 반드시 그런 셩격을 가지는건 아니다.
- 메시지 브로커는 위 문제 해결 가능한 중간층이다.

분산형 메시지 브로커 예
- Apache Kafka
- Amazon Kinesis

푸쉬형과 풀형
- push: 송신측의 제어로 데이터를 보내는 방식
- pull: 수신측의 주도로 데이터를 가져오는 방식
- 메시지 브로커는 데이터의 쓰기 속도를 조정하기 위한 완충 부분이며, 푸쉬 형에서 풀 형으로 메시지 배송의 타이밍을 변환.
- 메시지 브로커는 높은 빈도로 데이터를 쓰는 것에 최적화 되어 있으며, 여러 대의 노드에 부하 분산함으로써 성능을 끌어 올릴 수 있는 뛰어난 확장성 가짐.
- pull 형의 메시지 배송은 파일 사이즈 적정화에 도움 되는데, 소비자는 메시지 브로커로부터 일정한 간격으로 데이터를 취함으로써 적당히 모아진 데이터를 분산 스토리지에 기록함.

메시지 라우팅
- 메시지 브로커에 써넣은 데이터는 복수의 다른 소비자에서 읽어들일 수 있음
- 예를 들어 실시간 장애 감지에 사용하면서 같은 메시지를 장기적인 데이터 분석을 위한 스토리지에 저장 가능.

신뢰성(reliability)
- 모바일 회선과 같은 신뢰성이 낮은 네트워크에서는 반드시 메시지의 중복이나 누락이 발생한다.
- 위 문제를 어떻게 처리할지는 시스템마다 다르며 대부분의 경우 다음 중 하나를 보장하도록 설계된다.
  - at most once: 메시지는 한번만 전송된다. 그러나 도중에 전송에 실패해서 사라질 가능성이 있다.(결손 발생)
  - exactly once: 메시지는 손실되거나 중복 없이 한 번만 전달된다. 
  - at least once: 메시지는 확실히 전달되나 같은 것이 여러번 전달 될 가능성 있음(중복)
  - 대부분의 메시지 배송 시스템에선 at least once(메시지 중복 가능)로 시스템 구축한다.
    - 양쪽의 통신 내용을 보장해야하는 exactly once는 코디네이터의 존재가 필수적
    - 그러나 분산 시스템에서 코디네이터가 존재한다고 가정할 수 없다. 코디네이터가 멈출 수 있고, 통신이 끊길수 있다. 그 때마다 시스템을 멈출수는 없다.
    - 코디네이터의 판단에만 따르면 성능상의 문제로 시간이 너무 소요된다. 
    - 중복 제거는 메시지 배송 시스템 운영자에게 맡긴다
  

  
