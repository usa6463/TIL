# Message Broker

- 메시지 배송에 의해 보내진 데이터를 분산 스토리지에 저장할 때 주의가 필요함.
- 대량의 메시지를 안정적으로 받으려면 빈번한 쓰기에 견딜 수 있는 스토리지가 필요한데, 분산 스토리지가 반드시 그런 셩격을 가지는건 아니다.
- 메시지 브로커는 위 문제 해결 가능한 중간층이다.

분산형 메시지 브로커 예
- Apache Kafka
- Amazon Kinesis

푸쉬형과 풀형
- push: 송신측의 제어로 데이터를 보내는 방식
- pull: 수신측의 주도로 데이터를 가져오는 방식
- 메시지 브로커는 데이터의 쓰기 속도를 조정하기 위한 완충 부분이며, 푸쉬 형에서 풀 형으로 메시지 배송의 타이밍을 변환.
- 메시지 브로커는 높은 빈도로 데이터를 쓰는 것에 최적화 되어 있으며, 여러 대의 노드에 부하 분산함으로써 성능을 끌어 올릴 수 있는 뛰어난 확장성 가짐.
- pull 형의 메시지 배송은 파일 사이즈 적정화에 도움 되는데, 소비자는 메시지 브로커로부터 일정한 간격으로 데이터를 취함으로써 적당히 모아진 데이터를 분산 스토리지에 기록함.

메시지 라우팅
- 메시지 브로커에 써넣은 데이터는 복수의 다른 소비자에서 읽어들일 수 있음
- 예를 들어 실시간 장애 감지에 사용하면서 같은 메시지를 장기적인 데이터 분석을 위한 스토리지에 저장 가능.

신뢰성(reliability)
- 모바일 회선과 같은 신뢰성이 낮은 네트워크에서는 반드시 메시지의 중복이나 누락이 발생한다.
- 위 문제를 어떻게 처리할지는 시스템마다 다르며 대부분의 경우 다음 중 하나를 보장하도록 설계된다.
    - at most once: 메시지는 한번만 전송된다. 그러나 도중에 전송에 실패해서 사라질 가능성이 있다.(결손 발생)
    - exactly once: 메시지는 손실되거나 중복 없이 한 번만 전달된다.
    - at least once: 메시지는 확실히 전달되나 같은 것이 여러번 전달 될 가능성 있음(중복)
    - 대부분의 메시지 배송 시스템에선 at least once(메시지 중복 가능)로 시스템 구축한다.
        - 양쪽의 통신 내용을 보장해야하는 exactly once는 코디네이터의 존재가 필수적
        - 그러나 분산 시스템에서 코디네이터가 존재한다고 가정할 수 없다. 코디네이터가 멈출 수 있고, 통신이 끊길수 있다. 그 때마다 시스템을 멈출수는 없다.
        - 코디네이터의 판단에만 따르면 성능상의 문제로 시간이 너무 소요된다.
        - 중복 제거는 메시지 배송 시스템 운영자에게 맡긴다
    - 이 개념에 대해선 Message Delivery Semantics, 메시지 전달 보증 수준 이라고도 하는듯

## 참고
- [도서]빅데이터를 지탱하는 기술